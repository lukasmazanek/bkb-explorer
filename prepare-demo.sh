#!/bin/bash
#
# BKB Explorer - Data Preparation Script
#
# Copies ontology data from ontology-lift/export and bundles it
# into js/data.js for offline use.
#
# Includes both RBCZ production data and Test data.
#
# Usage: ./prepare-demo.sh
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
OUTPUT_FILE="$SCRIPT_DIR/js/data.js"
ONTOLOGY_LIFT_DIR="$SCRIPT_DIR/../ontology-lift"

echo "ðŸ¦ BKB Explorer - Preparing demo data..."
echo ""

# Check if ontology-lift exists
if [ ! -d "$ONTOLOGY_LIFT_DIR" ]; then
    echo "âŒ Error: ontology-lift directory not found at $ONTOLOGY_LIFT_DIR"
    exit 1
fi

# Find export directories
EXPORT_DIR="$ONTOLOGY_LIFT_DIR/export"
if [ ! -d "$EXPORT_DIR" ]; then
    # Try demo output
    EXPORT_DIR="$ONTOLOGY_LIFT_DIR/demo/output/cross-domain"
fi

if [ ! -d "$EXPORT_DIR" ]; then
    echo "âŒ Error: No export directory found. Run ontology-lift pipeline first."
    exit 1
fi

echo "ðŸ“‚ Using export directory: $EXPORT_DIR"
echo ""

# Find RBCZ ontology.json files
INVESTMENT_FILE=$(find "$EXPORT_DIR" -path "*Investment*" -name "ontology.json" | head -1)
PAYMENTS_FILE=$(find "$EXPORT_DIR" -path "*Payment*" -name "ontology.json" | head -1)
RETAIL_FILE=$(find "$EXPORT_DIR" -path "*Retail*" -name "ontology.json" | head -1)

# Find Test ontology.json files (from bkb-explorer/test)
TEST_ORDER_FILE="$SCRIPT_DIR/test/Order/Test:Order/ontology.json"
TEST_POSITION_FILE="$SCRIPT_DIR/test/Position/Test:Position/ontology.json"
TEST_TRANSACTION_FILE="$SCRIPT_DIR/test/Transaction/Test:Transaction/ontology.json"
TEST_PAYMENT_FILE="$SCRIPT_DIR/test/Payment/Test:Payment/ontology.json"

# Run test demo first to ensure test data exists
if [ ! -f "$TEST_ORDER_FILE" ]; then
    echo "ðŸ“¦ Generating test data..."
    "$SCRIPT_DIR/prepare-test-demo.sh" > /dev/null 2>&1 || true
fi

# Generate data.js
echo "ðŸ“ Generating $OUTPUT_FILE..."
echo ""

cat > "$OUTPUT_FILE" << 'HEADER'
/**
 * BKB Explorer - Data
 *
 * Auto-generated by prepare-demo.sh
 * DO NOT EDIT MANUALLY
 *
HEADER

echo " * Generated: $(date)" >> "$OUTPUT_FILE"
echo " */" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Domains index
echo "// Domain hierarchy" >> "$OUTPUT_FILE"
echo "const DOMAINS_DATA = {" >> "$OUTPUT_FILE"
echo '  "version": "1.0",' >> "$OUTPUT_FILE"
echo "  \"generated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"," >> "$OUTPUT_FILE"
echo '  "hierarchy": {' >> "$OUTPUT_FILE"
echo '    "RBCZ": {' >> "$OUTPUT_FILE"
echo '      "type": "enterprise",' >> "$OUTPUT_FILE"
echo '      "children": {' >> "$OUTPUT_FILE"
echo '        "MIB": {' >> "$OUTPUT_FILE"
echo '          "type": "business_unit",' >> "$OUTPUT_FILE"
echo '          "children": {' >> "$OUTPUT_FILE"

# Count RBCZ concepts
INV_COUNT=0
PAY_COUNT=0
RET_COUNT=0

if [ -f "$INVESTMENT_FILE" ]; then
    INV_COUNT=$(python3 -c "import json; print(len(json.load(open('$INVESTMENT_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi
if [ -f "$PAYMENTS_FILE" ]; then
    PAY_COUNT=$(python3 -c "import json; print(len(json.load(open('$PAYMENTS_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi
if [ -f "$RETAIL_FILE" ]; then
    RET_COUNT=$(python3 -c "import json; print(len(json.load(open('$RETAIL_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi

# Count Test concepts
TEST_ORDER_COUNT=0
TEST_POSITION_COUNT=0
TEST_TRANSACTION_COUNT=0
TEST_PAYMENT_COUNT=0

if [ -f "$TEST_ORDER_FILE" ]; then
    TEST_ORDER_COUNT=$(python3 -c "import json; print(len(json.load(open('$TEST_ORDER_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi
if [ -f "$TEST_POSITION_FILE" ]; then
    TEST_POSITION_COUNT=$(python3 -c "import json; print(len(json.load(open('$TEST_POSITION_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi
if [ -f "$TEST_TRANSACTION_FILE" ]; then
    TEST_TRANSACTION_COUNT=$(python3 -c "import json; print(len(json.load(open('$TEST_TRANSACTION_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi
if [ -f "$TEST_PAYMENT_FILE" ]; then
    TEST_PAYMENT_COUNT=$(python3 -c "import json; print(len(json.load(open('$TEST_PAYMENT_FILE'))['concepts']))" 2>/dev/null || echo 0)
fi

echo "            \"Investment\": { \"type\": \"domain\", \"stats\": { \"concepts\": $INV_COUNT } }," >> "$OUTPUT_FILE"
echo "            \"Payments\": { \"type\": \"domain\", \"stats\": { \"concepts\": $PAY_COUNT } }" >> "$OUTPUT_FILE"
echo '          }' >> "$OUTPUT_FILE"
echo '        },' >> "$OUTPUT_FILE"
echo "        \"Retail\": { \"type\": \"domain\", \"stats\": { \"concepts\": $RET_COUNT } }" >> "$OUTPUT_FILE"
echo '      }' >> "$OUTPUT_FILE"
echo '    },' >> "$OUTPUT_FILE"
echo '    "Test": {' >> "$OUTPUT_FILE"
echo '      "type": "test",' >> "$OUTPUT_FILE"
echo '      "children": {' >> "$OUTPUT_FILE"
echo "        \"Order\": { \"type\": \"domain\", \"stats\": { \"concepts\": $TEST_ORDER_COUNT } }," >> "$OUTPUT_FILE"
echo "        \"Position\": { \"type\": \"domain\", \"stats\": { \"concepts\": $TEST_POSITION_COUNT } }," >> "$OUTPUT_FILE"
echo "        \"Transaction\": { \"type\": \"domain\", \"stats\": { \"concepts\": $TEST_TRANSACTION_COUNT } }," >> "$OUTPUT_FILE"
echo "        \"Payment\": { \"type\": \"domain\", \"stats\": { \"concepts\": $TEST_PAYMENT_COUNT } }" >> "$OUTPUT_FILE"
echo '      }' >> "$OUTPUT_FILE"
echo '    }' >> "$OUTPUT_FILE"
echo '  },' >> "$OUTPUT_FILE"

# Cross-domain detection
echo '  "crossDomain": {' >> "$OUTPUT_FILE"
if [ -f "$INVESTMENT_FILE" ] && [ -f "$PAYMENTS_FILE" ]; then
    python3 << PYTHON >> "$OUTPUT_FILE"
import json

inv = json.load(open('$INVESTMENT_FILE'))
pay = json.load(open('$PAYMENTS_FILE'))

inv_names = {c['name'] for c in inv.get('concepts', [])}
pay_names = {c['name'] for c in pay.get('concepts', [])}

shared = inv_names & pay_names

entries = []
for name in sorted(shared):
    inv_concept = next((c for c in inv['concepts'] if c['name'] == name), None)
    fibo_uri = None
    if inv_concept and inv_concept.get('fibo_mapping'):
        fibo_uri = inv_concept['fibo_mapping'].get('uri')

    domains = ["Investment", "Payments"]
    entry = f'    "{name}": {{ "domains": {json.dumps(domains)}'
    if fibo_uri:
        entry += f', "fibo_uri": "{fibo_uri}"'
    entry += ' }'
    entries.append(entry)

print(',\n'.join(entries))
PYTHON
fi
echo '  }' >> "$OUTPUT_FILE"
echo '};' >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Investment data
echo "// Investment domain" >> "$OUTPUT_FILE"
echo -n "const INVESTMENT_DATA = " >> "$OUTPUT_FILE"
if [ -f "$INVESTMENT_FILE" ]; then
    cat "$INVESTMENT_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Investment: $INV_COUNT concepts"
else
    echo '{ "domain": { "name": "Investment", "path": "RBCZ:MIB:Investment" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Investment: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Payments data
echo "// Payments domain" >> "$OUTPUT_FILE"
echo -n "const PAYMENTS_DATA = " >> "$OUTPUT_FILE"
if [ -f "$PAYMENTS_FILE" ]; then
    cat "$PAYMENTS_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Payments: $PAY_COUNT concepts"
else
    echo '{ "domain": { "name": "Payments", "path": "RBCZ:MIB:Payments" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Payments: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Retail data
echo "// Retail domain" >> "$OUTPUT_FILE"
echo -n "const RETAIL_DATA = " >> "$OUTPUT_FILE"
if [ -f "$RETAIL_FILE" ]; then
    cat "$RETAIL_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Retail: $RET_COUNT concepts"
else
    echo '{ "domain": { "name": "Retail", "path": "RBCZ:Retail" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Retail: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Test Order data
echo "// Test Order domain" >> "$OUTPUT_FILE"
echo -n "const TEST_ORDER_DATA = " >> "$OUTPUT_FILE"
if [ -f "$TEST_ORDER_FILE" ]; then
    cat "$TEST_ORDER_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Test/Order: $TEST_ORDER_COUNT concepts"
else
    echo '{ "domain": { "name": "Order", "path": "Test:Order" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Test/Order: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Test Position data
echo "// Test Position domain" >> "$OUTPUT_FILE"
echo -n "const TEST_POSITION_DATA = " >> "$OUTPUT_FILE"
if [ -f "$TEST_POSITION_FILE" ]; then
    cat "$TEST_POSITION_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Test/Position: $TEST_POSITION_COUNT concepts"
else
    echo '{ "domain": { "name": "Position", "path": "Test:Position" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Test/Position: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Test Transaction data
echo "// Test Transaction domain" >> "$OUTPUT_FILE"
echo -n "const TEST_TRANSACTION_DATA = " >> "$OUTPUT_FILE"
if [ -f "$TEST_TRANSACTION_FILE" ]; then
    cat "$TEST_TRANSACTION_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Test/Transaction: $TEST_TRANSACTION_COUNT concepts"
else
    echo '{ "domain": { "name": "Transaction", "path": "Test:Transaction" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Test/Transaction: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Test Payment data
echo "// Test Payment domain" >> "$OUTPUT_FILE"
echo -n "const TEST_PAYMENT_DATA = " >> "$OUTPUT_FILE"
if [ -f "$TEST_PAYMENT_FILE" ]; then
    cat "$TEST_PAYMENT_FILE" >> "$OUTPUT_FILE"
    echo "  âœ… Test/Payment: $TEST_PAYMENT_COUNT concepts"
else
    echo '{ "domain": { "name": "Payment", "path": "Test:Payment" }, "concepts": [] }' >> "$OUTPUT_FILE"
    echo "  âš ï¸  Test/Payment: not found"
fi
echo ";" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Export
echo "// Export for application" >> "$OUTPUT_FILE"
echo "window.BKB_DATA = {" >> "$OUTPUT_FILE"
echo "  domains: DOMAINS_DATA," >> "$OUTPUT_FILE"
echo "  investment: INVESTMENT_DATA," >> "$OUTPUT_FILE"
echo "  payments: PAYMENTS_DATA," >> "$OUTPUT_FILE"
echo "  retail: RETAIL_DATA," >> "$OUTPUT_FILE"
echo "  order: TEST_ORDER_DATA," >> "$OUTPUT_FILE"
echo "  position: TEST_POSITION_DATA," >> "$OUTPUT_FILE"
echo "  transaction: TEST_TRANSACTION_DATA," >> "$OUTPUT_FILE"
echo "  payment: TEST_PAYMENT_DATA" >> "$OUTPUT_FILE"
echo "};" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
echo "console.log('âœ… BKB data loaded:', Object.keys(window.BKB_DATA));" >> "$OUTPUT_FILE"

# Report
FILE_SIZE=$(wc -c < "$OUTPUT_FILE" | tr -d ' ')
FILE_SIZE_KB=$((FILE_SIZE / 1024))
echo ""
echo "âœ… Generated $OUTPUT_FILE"
echo "   Size: ${FILE_SIZE_KB} KB"
echo ""
echo "ðŸš€ Ready! Open index.html in browser."
